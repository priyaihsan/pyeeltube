<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>GUI Python Interaction</title>
</head>
<body>
    <div class="main" id="_">
        <header></header>
        <div class="form">
            <h1>YouTube Thumbnails Downloader</h1>
            <div class="input">
                <input type="text" name="search" id="search" placeholder="Search ..." autocomplete="off" spellcheck="false" autofocus>
                <div class="btn">
                    <img src="icon/127_search.png" alt="" srcset="">
                    <input type="button" id="btn_search" value="" onclick="searchVideos()">
                </div>
                <div class="btn">
                    <img src="icon/127_folder.png" alt="" srcset="">
                    <input type="button" id="btn_directory" value="" onclick="setDirectory()">
                </div>
            </div>
        </div>
        <div class="panel" id="panel">
            <!-- <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content">
            <img src="" alt="" class="content"> -->
            <div id="mgcheck">
                <input type="checkbox" name="img" id="cb1" data-idx="0">
                <label for="cb1">
                    <img src="https://s1.zerochan.net/Sylvia.Lyyneheym.600.2877190.jpg" alt="" class="content">
                </label>
                <input type="checkbox" name="img" id="cb2" data-idx="1">
                <label for="cb2">
                    <img src="https://swall.teahub.io/photos/small/303-3033122_gakusen-toshi-asterisk-sylvia-lyyneheym.jpg" alt="" class="content">
                </label>
                <input type="checkbox" name="img" id="cb3" data-idx="2">
                <label for="cb3">
                    <img src="https://cdn.anisearch.com/images/character/cover/full/53/53444.jpg" alt="" class="content">
                </label>
                <input type="checkbox" name="img" id="cb4" data-idx="3">
                <label for="cb4">
                    <img src="https://i.pinimg.com/originals/d2/68/7f/d2687f09f2257d499dfa6eca4dc4907f.jpg" alt="" class="content">
                </label>
            </div>
            <div class="pan-menu">
                <div class="pan">
                    <img src="icon/127_trash.png" alt="" srcset="">
                    <button class="btn-img" id="btn_clear" onclick="clearChecked();"></button>
                </div>
                <div class="pan">
                    <span class="progress-download"></span>
                    <button class="number" id="btn_download" onclick="sendList();">
                        (0) Download
                    </button>
                </div>
            </div>
            <!-- <a href="https://img.youtube.com/vi/lvZFaf9p-fo/maxresdefault.jpg" id="frame" download="https://img.youtube.com/vi/lvZFaf9p-fo/maxresdefault.jpg">asd</a> -->
        </div>
        <span class="pathbar" id="pathbar" onclick="openDir();">üìÅ Save path: </span>
    </div>
    <div class="behind disabled" id="__">
        <span>Select your directory...</span>
    </div>



    <!-- SCRIPT -->
    <script src="eel.js"></script>
    <script>
        /*callPython = function() {
            eel.hello();
        }*/
        let index = -1
        let _pathed = false

        // preventing refresh caused pyeel
        eel.refresh();

        function listening() {
            var search = document.querySelector("#search");
            search.addEventListener("keyup", function(event) {
                if (event.keyCode === 13) {
                    event.preventDefault();
                    document.querySelector("#btn_search").click();
                }
            })
        }
        
        listening();

        function searchVideos() {
            var textbox = document.querySelector("#search");
            var title = textbox.value;
            eel.makeObj(title)
        }

        // function set directory in python
        function setDirectory() {
            eel.setDirectory()
        }

        eel.expose(getSelectedIndex)
        function getSelectedIndex() {
            var checkboxes = document.querySelectorAll("input[name='img']:checked");
            const btn_download = document.querySelector("#btn_download");
            let index = [];
            checkboxes.forEach(function(item) {
                index.push(item.getAttribute("data-idx"));
                //console.log(item.getAttribute("data-idx"))
            })
            if (index.length <= 0 && (_pathed === false || _pathed === true)) {
                btn_download.classList.add("disabled");
                btn_download.disabled = true
            } else if (index.length > 0 && _pathed === true) {
                btn_download.classList.remove("disabled");
                btn_download.disabled = false
            }
            console.log("current : " + _pathed)
            btn_download.innerHTML = `(${index.length}) Download`;
            return index
        }

        eel.expose(is_pathed)
        function is_pathed(path) {
            _pathed = path
        }

        eel.expose(makeObj);
        function makeObj(imgurl) {
            index = index + 1;
            var panel = document.querySelector("#mgcheck");
            var box = document.createElement("IMG");

            var _checkbox = document.createElement("INPUT");
            _checkbox.setAttribute("type", "checkbox");
            _checkbox.setAttribute("name", "img");
            _checkbox.setAttribute("id", `cb${index}`);
            _checkbox.setAttribute("data-idx", index);
            _checkbox.addEventListener("click", function(e) {
                eel.is_pathed();
                getSelectedIndex();
                //console.log(getSelectedIndex());
            })
            panel.appendChild(_checkbox);

            var _label = document.createElement("LABEL");
            _label.setAttribute("for", `cb${index}`);
            panel.appendChild(_label);


            box.setAttribute("class", "content");
            box.setAttribute("src", imgurl);
            box.setAttribute("draggable", "false")
            
            _label.appendChild(box);
        }
        eel.expose(clearObj);
        function clearObj() {
            index = -1
            var panel = document.querySelector("#mgcheck");
            panel.textContent = "";
            getSelectedIndex();
        }

        function sendList() {
            list = getSelectedIndex();
            eel.core_downloadThumbnails(list);
            //eel.getUrlFromIndex(list);
            //eel.createTk();
        }

        eel.expose(btnDownload)
        function btnDownload(status) {
            var btn_download = document.querySelector("#btn_download");
            if (status === true) {
                btn_download.innerHTML = "Downloading...";
                btn_download.classList.add("disabled");
                btn_download.disabled = true
            } else {
                btn_download.classList.remove("disabled");
                btn_download.disabled = false
            }
        }

        eel.expose(download)
        function download(url) {
            var index = getSelectedIndex();
            var frame = document.querySelector("#frame");
            index.forEach(function(i) {
                // console.log(i);
                frame.src = url;
            })
        }

        eel.expose(dialogSwap)
        function dialogSwap(status, path) {
            var body = document.getElementById("_");
            var behind = document.getElementById("__");
            var pathbar = document.querySelector("#pathbar");
            if (status === true) {
                body.classList.add("disabled");
                behind.classList.remove("disabled");
                pathbar.innerHTML = `üìÅ Save path: ${path}`
                is_pathed();
            } else {
                body.classList.remove("disabled");
                behind.classList.add("disabled");
                pathbar.innerHTML = `üìÅ Save path: ${path}`
                is_pathed();
            }
        }

        eel.expose(progressbar)
        function progressbar() {
            var download = document.querySelector(".progress-download");
            download.style.width = "0px";
            download.style.opacity = 0;
            download.style.backgroundColor = "rgb(255, 255, 255, 0.22)"
        }

        eel.expose(updateProgressbar)
        function updateProgressbar(amountDownload) {
            var download = document.querySelector("#btn_download");
            var download_style = getComputedStyle(download);
            var progressbar = document.querySelector(".progress-download");
            var progressbar_style = getComputedStyle(progressbar);
            
            var maxwidth = parseFloat(download_style.getPropertyValue("width").replace("px", ""));
            var curwidth = parseFloat(progressbar_style.getPropertyValue("width").replace("px", ""));
            var setwidth = parseFloat(maxwidth / amountDownload);
            progressbar.style.backgroundColor = "rgb(0, 0, 0, 0.22)"
            progressbar.style.opacity = 1;
            progressbar.style.width = curwidth + setwidth + "px";
        }

        eel.expose(clearChecked)
        function clearChecked() {
            var checkedList = document.querySelectorAll("input[name='img']:checked");
            checkedList.forEach(function(e) {
                e.checked = false;
            })
            getSelectedIndex();
        }

        function openDir() {
            eel.openDir();
        }
    </script>
</body>
</html>